<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goodness Healthcare ‚Äî Dashboard</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','Inter','Segoe UI','Roboto','Helvetica','Arial','sans-serif'] },
          colors: {
            brand: {
              50:'#eefaff',100:'#d8f1ff',200:'#b9e5ff',300:'#8fd6ff',400:'#5ec2ff',
              500:'#2aa7ff',600:'#1b83db',700:'#1767ad',800:'#174f83',900:'#163f66',
            },
          },
          boxShadow: { 'smooth': '0 10px 30px rgba(2, 8, 23, .08)' },
          backgroundImage: {
            'brand-grad': 'linear-gradient(135deg, #2aa7ff 0%, #8D6BFF 50%, #FF7AD9 100%)',
            'card-grad': 'linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.65))',
          },
        }
      }
    }
  </script>
  <style>
    .glass { backdrop-filter: saturate(1.2) blur(8px); -webkit-backdrop-filter: saturate(1.2) blur(8px); background: rgba(255,255,255,0.78); }
    .lift:hover { transform: translateY(-2px); }
    .transition-basic { transition: all .2s ease; }
    .fill-iframe { height: calc(100vh - 220px); }
    @media (min-width:1024px){ .fill-iframe{ height: calc(100vh - 180px);} }

    /* --- Sidebar fixes for mobile overflow & full-height background --- */
    :root { --topbar-safe: 72px; } /* approximate topbar height */
    #sidebar.mobile-fixed {
      position: fixed;
      top: calc(var(--topbar-safe) + 8px);
      bottom: 16px;
      left: 16px;
      width: 18rem;            /* w-72 */
      overflow-y: auto;        /* vertical scroll when needed */
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width:1024px){
      #sidebar { position: static; height: auto; max-height: calc(100vh - 0px); overflow-y: auto; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 via-indigo-50 to-rose-50 text-slate-800">

  <div class="h-1.5 w-full bg-brand-grad"></div>

  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/80 glass shadow-smooth">
    <div class="mx-auto max-w-[1400px] px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-3 py-3">
        <!-- Logo -->
        <div class="h-10 w-10 rounded-lg overflow-hidden ring-1 ring-slate-200 flex items-center justify-center">
          <img alt="Goodness Healthcare Logo" class="h-full w-full object-cover"
               src="data:image/svg+xml;utf8,
               <svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
                 <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>
                   <stop offset='0%' stop-color='%232aa7ff'/><stop offset='50%' stop-color='%238D6BFF'/><stop offset='100%' stop-color='%23FF7AD9'/>
                 </linearGradient></defs>
                 <rect width='160' height='160' rx='18' fill='url(%23g)'/>
                 <g fill='%23ffffff'><circle cx='55' cy='80' r='26'/><rect x='88' y='54' width='20' height='52' rx='10'/><rect x='68' y='70' width='60' height='20' rx='10'/></g>
               </svg>" />
        </div>
        <div class="flex-1">
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Goodness Healthcare</h1>
          <p class="text-xs sm:text-sm text-slate-600">Internal Pathology Lab Management</p>
        </div>

        <!-- Mobile sidebar toggle -->
        <button id="sidebarToggle" class="lg:hidden px-3 py-2 rounded-lg bg-white ring-1 ring-slate-200 hover:ring-brand-300 transition-basic"
                aria-label="Toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <div class="mx-auto max-w-[1400px] px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex gap-6">
      <!-- Sidebar -->
      <aside id="sidebar"
             class="glass w-72 shrink-0 rounded-2xl p-4 ring-1 ring-white/40 shadow-smooth transition-basic
                    mobile-fixed lg:translate-x-0 lg:static">
        <!-- Signed-in user -->
        <div class="mb-4 rounded-xl bg-white/70 p-4 ring-1 ring-slate-200">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-full bg-brand-100 ring-1 ring-brand-300 flex items-center justify-center text-brand-700 font-semibold select-none" id="userAvatar">U</div>
            <div class="min-w-0">
              <p id="userName" class="truncate font-semibold text-sm">‚Äî</p>
              <p id="userEmail" class="truncate text-xs text-slate-600">‚Äî</p>
            </div>
          </div>
          <button id="signOutBtn"
                  class="mt-3 w-full rounded-lg bg-gradient-to-r from-brand-500 to-violet-500 py-2 text-white text-sm font-medium shadow-sm hover:shadow active:scale-[.99] transition-basic">
            Sign Out
          </button>
        </div>

        <!-- Nav (text size increased) -->
        <nav class="space-y-1 text-base"> <!-- text-base for bigger font -->
          <a href="login.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic ring-1 ring-transparent hover:ring-brand-200 hover:bg-white" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üîê</span>
            <span>Login Info</span>
          </a>
          <a href="home.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic ring-1 ring-transparent hover:ring-brand-200 hover:bg-white" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üè†</span>
            <span>Dashboard</span>
          </a>
          <!-- Current section -->
          <a href="dashboard.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 ring-2 ring-brand-300 bg-white shadow-sm" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-brand-100">‚ûï</span>
            <span class="font-semibold text-brand-800">Add Entry</span>
            <span class="ml-auto text-[10px] rounded bg-brand-100 px-1.5 py-0.5 text-brand-700 ring-1 ring-brand-200">current</span>
          </a>
          <a href="schedule.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üóìÔ∏è</span>
            <span>Schedule</span>
          </a>
          <a href="payment.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üí≥</span>
            <span>Payment</span>
          </a>
          <a href="reports.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üìÑ</span>
            <span>Reports</span>
          </a>
          <a href="inventory.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üì¶</span>
            <span>Inventory</span>
          </a>
          <a href="medical-camp.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">‚õ∫</span>
            <span>Medical Camp</span>
          </a>
          <a href="database.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üóÑÔ∏è</span>
            <span>Database</span>
          </a>
          <a href="test-prices.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üè∑Ô∏è</span>
            <span>Test Prices</span>
          </a>
          <a href="staff.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üë•</span>
            <span>Staff</span>
          </a>
          <a href="analytics.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">üìä</span>
            <span>Analytics</span>
          </a>
          <a href="ai-assistant.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">ü§ñ</span>
            <span>AI Assistant</span>
          </a>
          <a href="about.html" class="group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">‚ÑπÔ∏è</span>
            <span>About Us</span>
          </a>
        </nav>
      </aside>

      <!-- Content -->
      <main class="flex-1">
        <!-- Title card -->
        <div class="glass rounded-2xl ring-1 ring-white/40 shadow-smooth p-5 mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl font-semibold">Add Entry</h2>
              <p class="text-sm text-slate-600">Create a new patient record or booking. Loading from <span class="font-mono">add-entry.html</span>.</p>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="rounded-full bg-brand-100 text-brand-800 px-2.5 py-1 ring-1 ring-brand-200">Secure</span>
              <span class="rounded-full bg-emerald-100 text-emerald-700 px-2.5 py-1 ring-1 ring-emerald-200">Live</span>
            </div>
          </div>
        </div>

        <!-- Embedded add-entry.html instead of Tally -->
        <section class="rounded-2xl ring-1 ring-white/40 shadow-smooth bg-card-grad p-4 sm:p-6">
          <div class="mb-3 flex items-center justify-between gap-3">
            <div>
              <h3 class="font-semibold">Patient Intake</h3>
              <p class="text-xs text-slate-600">Source file: <span class="font-mono">add-entry.html</span></p>
            </div>
            <a href="add-entry.html" target="_blank" class="text-xs rounded-lg px-3 py-2 ring-1 ring-brand-300 bg-white hover:bg-brand-50 transition-basic">Open in new tab</a>
          </div>

          <div class="rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white">
            <iframe
              src="add-entry.html"
              width="100%"
              class="block w-full fill-iframe"
              frameborder="0"
              marginheight="0"
              marginwidth="0"
              title="Add Entry ‚Äî Internal Form">
            </iframe>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div id="overlay" class="fixed inset-0 bg-black/20 backdrop-blur-sm lg:hidden opacity-0 pointer-events-none transition-opacity"></div>

  <!-- Firebase v10 (CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXQyQRw4JRaWDNbca4YQkanMWnfu8SuH0",
      authDomain: "pathologylab-9d156.firebaseapp.com",
      projectId: "pathologylab-9d156",
      storageBucket: "pathologylab-9d156.appspot.com",
      messagingSenderId: "874537581352",
      appId: "1:874537581352:web:9dbcbe269d561c8d676e1d",
      measurementId: "G-S279W29G9Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let db = null;
    try { db = getFirestore(app); } catch (e) { console.warn("Firestore init skipped/failed:", e); }

    const userNameEl  = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const userAvatar  = document.getElementById('userAvatar');
    const signOutBtn  = document.getElementById('signOutBtn');

    function initialsFromName(name, email) {
      const source = (name || email || 'U').trim();
      const parts = source.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return source.slice(0,2).toUpperCase();
    }

    function applyRoleVisibility(roleOrRoles) {
      const roleSet = new Set();
      if (Array.isArray(roleOrRoles)) roleOrRoles.forEach(r => roleSet.add(String(r).toLowerCase()));
      else if (roleOrRoles) String(roleOrRoles).split(',').map(s=>s.trim().toLowerCase()).forEach(r => roleSet.add(r));
      document.querySelectorAll('[data-roles]').forEach(el => {
        const allowed = String(el.getAttribute('data-roles') || '')
          .split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        if (allowed.length && roleSet.size) {
          const match = allowed.some(r => roleSet.has(r));
          if (!match) el.classList.add('hidden');
        }
      });
    }

    async function fetchUserRole(uid) {
      if (!db) return null;
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) {
          const data = snap.data();
          return data?.roles ?? data?.role ?? null;
        }
      } catch (err) { console.warn('Role fetch failed:', err); }
      return null;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.replace('login.html'); return; }
      const name = user.displayName || '';
      const email = user.email || '';
      userNameEl.textContent  = name || '(No display name)';
      userEmailEl.textContent = email || '(No email)';
      userAvatar.textContent  = initialsFromName(name, email);

      const roleOrRoles = await fetchUserRole(user.uid);
      if (roleOrRoles) applyRoleVisibility(roleOrRoles);
    });

    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try { await signOut(auth); } catch (e) { alert('Failed to sign out. Please try again.'); console.error(e); }
    });

    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const toggle  = document.getElementById('sidebarToggle');
    const overlay = document.getElementById('overlay');

    function openSidebar() {
      sidebar.style.transform = 'translateX(0)';
      overlay.style.opacity = '1';
      overlay.style.pointerEvents = 'auto';
    }
    function closeSidebar() {
      sidebar.style.transform = '';
      overlay.style.opacity = '0';
      overlay.style.pointerEvents = 'none';
    }
    toggle?.addEventListener('click', () => {
      const isOpen = sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === 'translateX(0)';
      isOpen ? closeSidebar() : openSidebar();
    });
    overlay?.addEventListener('click', closeSidebar);

    const mq = window.matchMedia('(min-width: 1024px)');
    function handleMQ(e){ if (e.matches) closeSidebar(); }
    mq.addEventListener ? mq.addEventListener('change', handleMQ) : mq.addListener(handleMQ);
  </script>
</body>
</html>
