<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goodness Healthcare — Dashboard</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','Inter','Segoe UI','Roboto','Helvetica','Arial','sans-serif'] },
          colors: {
            brand: {
              50:'#eefaff',100:'#d8f1ff',200:'#b9e5ff',300:'#8fd6ff',400:'#5ec2ff',
              500:'#2aa7ff',600:'#1b83db',700:'#1767ad',800:'#174f83',900:'#163f66',
            },
          },
          boxShadow: { smooth: '0 10px 30px rgba(2, 8, 23, .08)' },
          backgroundImage: {
            'brand-grad': 'linear-gradient(135deg, #2aa7ff 0%, #8D6BFF 50%, #FF7AD9 100%)',
            'card-grad': 'linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.65))',
          },
        }
      }
    }
  </script>

  <style>
    .glass { backdrop-filter: saturate(1.2) blur(8px); -webkit-backdrop-filter: saturate(1.2) blur(8px); background: rgba(255,255,255,0.75); }
    .lift:hover { transform: translateY(-2px); }
    .transition-basic { transition: all .2s ease; }
    .fade { transition: opacity .25s ease; }
    .content-frame { display:block; width:100%; border:0; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 via-indigo-50 to-rose-50 text-slate-800">

  <!-- Decorative gradient ribbon -->
  <div class="h-1.5 w-full bg-brand-grad"></div>

  <!-- Topbar -->
  <header id="topbar" class="sticky top-0 z-40 bg-white/80 glass shadow-smooth">
    <div class="mx-auto max-w-[1400px] px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-3 py-3">
        <!-- GitHub-hosted Logo.png -->
        <div class="h-10 w-10 rounded-lg overflow-hidden ring-1 ring-slate-200 flex items-center justify-center bg-white">
          <img alt="Goodness Healthcare Logo" class="h-full w-full object-contain" src="Logo.png" />
        </div>

        <div class="flex-1 min-w-0">
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">Goodness Healthcare</h1>
          <p class="text-xs sm:text-sm text-slate-600">Internal Pathology Lab Management</p>
        </div>

        <!-- Mobile sidebar toggle -->
        <button id="sidebarToggle" class="lg:hidden px-3 py-2 rounded-lg bg-white ring-1 ring-slate-200 hover:ring-brand-300 transition-basic" aria-label="Toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <div id="pageWrap" class="mx-auto max-w-[1400px] px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex gap-6">
      <!-- Sidebar -->
      <aside id="sidebar"
             class="glass w-72 shrink-0 rounded-2xl p-4 ring-1 ring-white/40 shadow-smooth transition-basic
                    fixed top-24 bottom-4 left-4 z-30 translate-x-[-120%] lg:translate-x-0
                    lg:static lg:inset-auto lg:z-auto
                    h-[calc(100vh-7rem)] lg:h-[calc(100vh-8rem)] overflow-y-auto">

        <!-- Signed-in user summary + Sign Out -->
        <div class="mb-4 rounded-xl bg-white/70 p-3 ring-1 ring-slate-200">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-full bg-brand-100 ring-1 ring-brand-300 flex items-center justify-center text-brand-700 font-semibold select-none" id="userAvatar">U</div>
            <div class="min-w-0">
              <p id="userName" class="truncate font-semibold text-sm">—</p>
              <p id="userEmail" class="truncate text-xs text-slate-600">—</p>
            </div>
          </div>
          <button id="signOutBtn" class="mt-3 w-full rounded-lg bg-gradient-to-r from-brand-500 to-violet-500 py-2 text-white text-sm font-medium shadow-sm hover:shadow active:scale-[.99] transition-basic">
            Sign Out
          </button>
        </div>

        <!-- Nav -->
        <nav id="sideNav" class="space-y-1 text-base">
          <a href="login.html" data-target="login.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic ring-1 ring-transparent hover:ring-brand-200 hover:bg-white" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🔐</span>
            <span>Login Info</span>
          </a>

          <a href="home.html" data-target="home.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic ring-1 ring-transparent hover:ring-brand-200 hover:bg-white" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🏠</span>
            <span>Dashboard</span>
          </a>

          <a href="entry.html" data-target="entry.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100">➕</span>
            <span>Add Entry</span>
          </a>

          <a href="schedule.html" data-target="schedule.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🗓️</span>
            <span>Schedule</span>
          </a>

          <a href="payment.html" data-target="payment.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">💳</span>
            <span>Payment</span>
          </a>

          <a href="reports.html" data-target="reports.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">📄</span>
            <span>Reports</span>
          </a>

          <a href="inventory.html" data-target="inventory.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">📦</span>
            <span>Inventory</span>
          </a>

          <a href="medical-camp.html" data-target="medical-camp.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">⛺</span>
            <span>Medical Camp</span>
          </a>

          <a href="database.html" data-target="database.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🗄️</span>
            <span>Database</span>
          </a>

          <a href="test-prices.html" data-target="test-prices.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🏷️</span>
            <span>Test Prices</span>
          </a>

          <a href="staff.html" data-target="staff.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">👥</span>
            <span>Staff</span>
          </a>

          <a href="analytics.html" data-target="analytics.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">📊</span>
            <span>Analytics</span>
          </a>

          <a href="ai-assistant.html" data-target="ai-assistant.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">🤖</span>
            <span>AI Assistant</span>
          </a>

          <a href="about.html" data-target="about.html" class="nav-link group flex items-center gap-3 rounded-lg px-3 py-2 lift transition-basic hover:bg-white hover:ring-1 hover:ring-brand-200" data-roles="admin,staff">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-slate-100 group-hover:bg-brand-100">ℹ️</span>
            <span>About Us</span>
          </a>
        </nav>
      </aside>

      <!-- Content -->
      <main class="flex-1">
        <section id="contentCard" class="rounded-2xl ring-1 ring-white/40 shadow-smooth bg-card-grad p-0 overflow-hidden">
          <iframe id="contentFrame" src="entry.html" class="content-frame fade opacity-100" title="Content Area"></iframe>
        </section>
      </main>
    </div>
  </div>

  <!-- Mobile overlay to close sidebar when open -->
  <div id="overlay" class="fixed inset-0 bg-black/20 backdrop-blur-sm lg:hidden opacity-0 pointer-events-none transition-opacity"></div>

  <!-- Firebase v10 (Modular, CDN) + Auth Guard + Role-based visibility -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXQyQRw4JRaWDNbca4YQkanMWnfu8SuH0",
      authDomain: "pathologylab-9d156.firebaseapp.com",
      projectId: "pathologylab-9d156",
      storageBucket: "pathologylab-9d156.appspot.com",
      messagingSenderId: "874537581352",
      appId: "1:874537581352:web:9dbcbe269d561c8d676e1d",
      measurementId: "G-S279W29G9Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let db = null;
    try { db = getFirestore(app); } catch (e) { console.warn("Firestore init skipped/failed:", e); }

    const userNameEl  = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const userAvatar  = document.getElementById('userAvatar');
    const signOutBtn  = document.getElementById('signOutBtn');

    const sidebar = document.getElementById('sidebar');
    const toggle  = document.getElementById('sidebarToggle');
    const overlay = document.getElementById('overlay');
    const contentCard  = document.getElementById('contentCard');
    const contentFrame = document.getElementById('contentFrame');
    const sideNav      = document.getElementById('sideNav');

    function initialsFromName(name, email) {
      const source = (name || email || 'U').trim();
      const parts = source.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return source.slice(0,2).toUpperCase();
    }

    function applyRoleVisibility(roleOrRoles) {
      const roleSet = new Set();
      if (Array.isArray(roleOrRoles)) roleOrRoles.forEach(r => roleSet.add(String(r).toLowerCase()));
      else if (roleOrRoles) String(roleOrRoles).split(',').map(s=>s.trim().toLowerCase()).forEach(r => roleSet.add(r));
      document.querySelectorAll('[data-roles]').forEach(el => {
        const allowed = String(el.getAttribute('data-roles') || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
        if (allowed.length && roleSet.size) {
          const match = allowed.some(r => roleSet.has(r));
          if (!match) el.classList.add('hidden');
        }
      });
    }

    async function fetchUserRole(uid) {
      if (!db) return null;
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) {
          const data = snap.data();
          return data?.roles ?? data?.role ?? null;
        }
      } catch (err) { console.warn('Role fetch failed:', err); }
      return null;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.replace('login.html'); return; }
      const name = user.displayName || '';
      const email = user.email || '';
      userNameEl.textContent  = name || '(No display name)';
      userEmailEl.textContent = email || '(No email)';
      userAvatar.textContent  = initialsFromName(name, email);
      const roleOrRoles = await fetchUserRole(user.uid);
      if (roleOrRoles) applyRoleVisibility(roleOrRoles);
    });

    signOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); } catch (e) { alert('Failed to sign out. Please try again.'); console.error(e); }
    });

    // Mobile Sidebar toggle
    function openSidebar() { sidebar.style.transform = 'translateX(0)'; overlay.style.opacity = '1'; overlay.style.pointerEvents = 'auto'; }
    function closeSidebar() { sidebar.style.transform = ''; overlay.style.opacity = '0'; overlay.style.pointerEvents = 'none'; }
    toggle?.addEventListener('click', () => {
      const isOpen = sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === 'translateX(0)';
      isOpen ? closeSidebar() : openSidebar();
    });
    overlay?.addEventListener('click', closeSidebar);
    const mq = window.matchMedia('(min-width: 1024px)');
    function handleMQ(e){ if (e.matches) closeSidebar(); }
    mq.addEventListener ? mq.addEventListener('change', handleMQ) : mq.addListener(handleMQ);

    // Active Tab Highlighting
    function setActiveLink(targetPath) {
      const links = sideNav.querySelectorAll('.nav-link');
      links.forEach(a => {
        a.classList.remove('ring-2','ring-brand-300','bg-white','shadow-sm','text-brand-800');
        const badge = a.querySelector('.current-badge'); if (badge) badge.remove();
      });
      const active = [...links].find(a => (a.dataset.target || a.getAttribute('href')) === targetPath);
      if (active) {
        active.classList.add('ring-2','ring-brand-300','bg-white','shadow-sm','text-brand-800');
        const span = document.createElement('span');
        span.className = "current-badge ml-auto text-[10px] rounded bg-brand-100 px-1.5 py-0.5 text-brand-700 ring-1 ring-brand-200";
        span.textContent = "current";
        active.appendChild(span);
      }
    }

    // SPA: Load into content without full page reload
    function loadSection(targetPath, push = true) {
      if (!targetPath) return;
      if (contentFrame.getAttribute('src') === targetPath) return;

      setActiveLink(targetPath);
      contentFrame.style.opacity = '0';
      const onLoad = () => {
        contentFrame.removeEventListener('load', onLoad);
        requestAnimationFrame(() => { computeContentHeight(); contentFrame.style.opacity = '1'; });
      };
      contentFrame.addEventListener('load', onLoad);
      contentFrame.src = targetPath;

      if (push) history.pushState({ targetPath }, "", "#" + encodeURIComponent(targetPath));
      closeSidebar();
    }

    sideNav.addEventListener('click', (e) => {
      const a = e.target.closest('a.nav-link'); if (!a) return;
      const targetPath = a.dataset.target || a.getAttribute('href'); if (!targetPath) return;
      e.preventDefault(); loadSection(targetPath, true);
    });

    window.addEventListener('popstate', (e) => {
      const targetPath = e.state?.targetPath || decodeURIComponent((location.hash || '').slice(1)) || 'entry.html';
      loadSection(targetPath, false);
    });

    // Boot
    const bootPath = decodeURIComponent((location.hash || '').slice(1)) || 'entry.html';
    setActiveLink(bootPath);
    if (contentFrame.getAttribute('src') !== bootPath) contentFrame.src = bootPath;

    // Content height: stretch to bottom
    function computeContentHeight() {
      const rect = contentCard.getBoundingClientRect();
      const bottomPadding = 16;
      const available = Math.max(200, window.innerHeight - rect.top - bottomPadding);
      contentFrame.style.height = available + "px";
    }
    window.addEventListener('load', computeContentHeight);
    window.addEventListener('resize', computeContentHeight);
    window.addEventListener('orientationchange', computeContentHeight);
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(() => computeContentHeight()).catch(()=>{}); }
    computeContentHeight();
  </script>
</body>
</html>
