<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add Entry – Patient & Visit Form</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  /* =========================
     Design System (Premium Light)
     ========================= */
  :root{
    /* Base colors (slate) */
    --slate-900:#0f172a; --slate-800:#1f2937; --slate-700:#334155; --slate-600:#475569;
    --slate-500:#64748b; --slate-300:#cbd5e1; --slate-200:#e2e8f0; --slate-100:#f1f5f9;

    /* Brand gradient: from-sky-400 via-indigo-500 to-pink-400 */
    --brand-from:#38bdf8; /* sky-400 */
    --brand-via:#6366f1;  /* indigo-500 */
    --brand-to:#f472b6;   /* pink-400 */
    --brand-grad: linear-gradient(90deg, var(--brand-from), var(--brand-via), var(--brand-to));
    --brand-ring: 0 0 0 3px rgba(99,102,241,.28); /* focus ring (indigo-500 ~300 ring) */

    /* Background gradient: bg-gradient-to-br from-sky-50 via-indigo-50 to-rose-50 */
    --bg-grad: radial-gradient(1200px 600px at -10% -10%, rgba(125,211,252,.28) 0%, transparent 45%),
               radial-gradient(1000px 500px at 110% -10%, rgba(199,210,254,.28) 0%, transparent 45%),
               radial-gradient(800px 400px at 50% 120%, rgba(254,205,211,.3) 0%, transparent 50%),
               linear-gradient(to bottom right, #f0f9ff, #eef2ff, #fff1f2);

    /* Surfaces */
    --glass-bg: rgba(255,255,255,.66);
    --glass-border: rgba(148,163,184,.22);
    --shadow-sm: 0 6px 20px rgba(2,6,23,.06);
    --shadow-lg: 0 24px 60px rgba(2,6,23,.10);

    /* Radii & spacing */
    --radius-xl: 18px;      /* rounded-2xl-ish */
    --radius-lg: 12px;
    --radius-md: 10px;

    /* Status */
    --ok:#10b981; --warn:#f59e0b; --error:#ef4444;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--slate-800);
    background: var(--bg-grad);
    font-size:16px;
  }

  /* Container: max-w-[1400px] with generous padding p-4 sm:p-6 */
  .wrap{max-width:1400px;margin:32px auto;padding:16px}
  @media(min-width:640px){ .wrap{padding:24px} }

  /* Headings & text scale */
  .headline{font-weight:800;letter-spacing:.2px;margin:0 0 14px;color:var(--slate-800)}
  .headline{font-size:20px}
  @media(min-width:640px){ .headline{font-size:24px} }
  @media(min-width:1024px){ .headline{font-size:28px} }
  .muted{color:var(--slate-600)}
  .helper{font-size:12px;color:var(--slate-600)}

  /* Tabs */
  .tabs{
    display:flex;gap:10px;background:var(--glass-bg);padding:8px;border-radius:var(--radius-lg);
    box-shadow:var(--shadow-sm);backdrop-filter: blur(10px);border:1px solid var(--glass-border)
  }
  .tab-btn{
    appearance:none;border:1px solid var(--slate-200);background:#fff;border-radius:var(--radius-md);
    padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    color:var(--slate-700)
  }
  .tab-btn:hover{box-shadow:var(--shadow-sm)}
  .tab-btn.active{
    background: var(--brand-grad); color:#fff; border-color:transparent;
    box-shadow:var(--shadow-sm)
  }
  .tab-panel{margin-top:14px}

  /* Cards (Frosted Glass) */
  .card{
    background:var(--glass-bg);border-radius:var(--radius-xl);box-shadow:var(--shadow-lg);
    overflow:hidden;margin-bottom:18px;border:1px solid var(--glass-border);backdrop-filter: blur(12px);
    transition: transform .18s ease, box-shadow .25s ease
  }
  .card:hover{ transform: translateY(-2px); box-shadow:0 28px 70px rgba(2,6,23,.14) }
  .card-header{
    padding:16px 20px;border-bottom:1px solid var(--glass-border);
    display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.55)
  }
  .card-header h2{
    margin:0;color:var(--slate-800);font-weight:600;
    font-size:18px
  }
  @media(min-width:640px){ .card-header h2{font-size:20px} }
  .card-body{padding:18px}
  @media(min-width:640px){ .card-body{padding:24px} }

  /* Grid */
  .grid{display:grid;gap:16px}
  @media(min-width:768px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  @media(min-width:1024px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
  .span-all{grid-column:1 / -1}

  /* Form basics */
  label{display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:var(--slate-700)}
  .req::after{content:" *";color:var(--error);font-weight:700}
  input[type="text"], input[type="tel"], input[type="number"], input[type="time"],
  input[type="date"], select, .multiselect, .readonly {
    width:100%;padding:12px 14px;border:1px solid var(--slate-200);border-radius:var(--radius-md);
    background:#fff;outline:none;transition:.2s box-shadow,.2s border-color;
    font-size:14px; color:var(--slate-800)
  }
  input:focus, select:focus, .multiselect:focus-within{box-shadow:var(--brand-ring);border-color:#c7d2fe}
  .hint{font-size:12px;color:var(--slate-600);margin-top:6px}
  .readonly{background:#f8fafc}

  /* Bigger fonts only in New Entry tab (still balanced) */
  #panel-newentry{font-size:16px}
  #panel-newentry label{font-size:14px}
  #panel-newentry input[type="text"],
  #panel-newentry input[type="tel"],
  #panel-newentry input[type="number"],
  #panel-newentry input[type="time"],
  #panel-newentry input[type="date"],
  #panel-newentry select,
  #panel-newentry .multiselect,
  #panel-newentry .readonly,
  #panel-newentry .ms-input{font-size:16px;padding:14px 16px}
  #panel-newentry .hint{font-size:12px}
  #panel-newentry .card-header h2{font-size:20px}

  /* Multiselect (Tests) */
  .multiselect{position:relative;padding:8px;border-radius:var(--radius-md)}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{display:flex;align-items:center;gap:6px;background:rgba(99,102,241,.08);border:1px solid #e0e7ff;
        padding:6px 8px;border-radius:999px;font-size:12px;color:#3730a3}
  .chip button{all:unset;cursor:pointer;line-height:0}
  .chip button:hover{color:var(--error)}
  .ms-input{border:none;outline:none;min-width:140px;font-size:14px;padding:6px;background:transparent}
  .ms-popup{
    position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:30;background:#fff;border:1px solid var(--slate-200);
    border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);max-height:260px;overflow:auto
  }
  .ms-list{list-style:none;margin:0;padding:6px}
  .ms-item{padding:10px 12px;border-radius:10px;cursor:pointer}
  .ms-item:hover{background:#f3f4f6}
  .ms-empty{padding:14px;text-align:center;color:var(--slate-600);font-size:13px}

  /* Progress */
  .progress{height:12px;background:#eef2f7;border-radius:999px;overflow:hidden;width:100%}
  .bar{
    height:100%;width:0%;background:var(--brand-grad);
    transition:width .35s ease;border-radius:999px
  }

  /* Buttons */
  .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
  .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;font-weight:700;padding:12px 16px;transition:transform .12s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease}
  .btn.primary{background:var(--brand-grad);color:#fff;box-shadow:0 10px 24px rgba(99,102,241,.25)}
  .btn.primary:hover{transform:translateY(-1px)}
  .btn.ghost{background:#fff;border:1px solid var(--slate-200);color:var(--slate-800)}
  .btn.ghost:hover{box-shadow:var(--shadow-sm);background:#f8fafc}
  .btn.danger{background:#fff;border:1px solid #fecaca;color:#b91c1c}
  .btn.danger:hover{background:#fff1f2}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.8;cursor:not-allowed}
  .btn.sm{padding:8px 10px;border-radius:10px;font-weight:700}

  .spinner{
    width:18px;height:18px;border:3px solid rgba(255,255,255,.6);border-top-color:#fff;border-radius:50%;
    display:inline-block;vertical-align:middle;margin-right:8px;animation:spin .8s linear infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .toast{
    position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;
    box-shadow:var(--shadow-lg);opacity:0;transform:translateY(10px);transition:.25s;z-index:1000;
  }
  .toast.show{opacity:1;transform:translateY(0)}

  .money{font-variant-numeric:tabular-nums}

  /* In-Progress redesigned as CARDS (narrower reading width) */
  #panel-inprogress .card-body{max-width:860px;margin:0 auto}
  .inprogress-cards{display:grid;gap:16px}
  .card-item{
    border:1px solid var(--glass-border);background:rgba(255,255,255,.9);border-radius:var(--radius-xl);padding:16px;
    box-shadow:var(--shadow-sm);transition:transform .16s ease, box-shadow .2s ease
  }
  .card-item:hover{ transform:translateY(-2px); box-shadow:0 16px 40px rgba(2,6,23,.12) }
  .card-top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
  .card-name{font-weight:800;font-size:18px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--slate-800)}
  .card-date{color:var(--slate-600);font-size:14px;flex:0 0 auto}
  .card-stage{margin:6px 0 10px 0;color:#374151;font-size:14px}
  .card-actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
  @media(max-width:520px){
    .card-name{font-size:17px}
    .card-top{flex-direction:column;align-items:flex-start}
    .card-actions{justify-content:flex-start}
  }

  /* Autocomplete (Patient Name) */
  .autocomplete{position:relative}
  .suggestions{
    position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--slate-200);
    border-radius:var(--radius-lg);max-height:240px;overflow-y:auto;z-index:60;box-shadow:var(--shadow-sm)
  }
  .suggestions div{padding:10px 12px;cursor:pointer}
  .suggestions div:hover{background:#f3f4f6}
</style>
</head>
<body>
  <div class="wrap">
    <h1 class="headline">Patient Entries</h1>
    <p class="muted" style="margin-top:-4px;margin-bottom:18px;font-size:14px">Manage in-progress patients and add new entries. Clean, consistent, and fast.</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="inprogress">In Progress</button>
      <button class="tab-btn" data-tab="newentry">New Entry</button>
    </div>

    <!-- In Progress Panel (Cards) -->
    <section id="panel-inprogress" class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h2 class="text-xl sm:text-2xl font-semibold">In Progress (not “all complete”)</h2>
        </div>
        <div class="card-body" id="inProgressBody">
          <div id="inProgressList" class="inprogress-cards"></div>
          <div id="inProgressEmpty" class="hint">No in-progress items right now.</div>
        </div>
      </div>
    </section>

    <!-- New Entry Panel -->
    <section id="panel-newentry" class="tab-panel" hidden>
      <form id="entryForm" class="card" novalidate>
        <div class="card-header">
          <h2 class="text-xl sm:text-2xl font-semibold">Patient Details</h2>
        </div>
        <div class="card-body">
          <div class="grid cols-3">
            <div class="autocomplete">
              <label class="req">Name</label>
              <input type="text" name="patient_name" id="patientName" required placeholder="Full name" autocomplete="off" />
              <div id="nameSuggestions" class="suggestions" hidden></div>
              <div class="hint">Start typing to search previous patients and auto-fill details.</div>
            </div>
            <div>
              <label class="req">Age</label>
              <input type="number" name="age" required min="0" max="120" placeholder="Years" />
            </div>
            <div>
              <label class="req">Gender</label>
              <select name="gender" required>
                <option value="" disabled selected>Select</option>
                <option>Male</option><option>Female</option><option>Other</option>
              </select>
            </div>
            <div>
              <label class="req">Contact No.</label>
              <input type="tel" name="contact" required pattern="[0-9]{10}" placeholder="10-digit number" />
              <div class="hint">Digits only, e.g., 9876543210</div>
            </div>
            <div>
              <label>Alternate Contact</label>
              <input type="tel" name="alt_contact" pattern="[0-9]{10}" placeholder="Optional" />
            </div>
            <div>
              <label id="addrLabel">Address</label>
              <input type="text" name="address" id="address" placeholder="Required for Home visit" />
            </div>
          </div>
        </div>

        <div class="card-header">
          <h2 class="text-xl sm:text-2xl font-semibold">Test & Visit Details</h2>
        </div>
        <div class="card-body">
          <div class="grid cols-3">
            <!-- Tests multiselect -->
            <div class="span-all">
              <label class="req">Tests (multi-select)</label>
              <div class="multiselect" id="testsSelect" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                <div class="chips" id="chips">
                  <input class="ms-input" id="msInput" placeholder="Type to search…"/>
                </div>
                <div class="ms-popup" id="msPopup" hidden>
                  <ul class="ms-list" id="msList" role="listbox" aria-label="Tests"></ul>
                  <div class="ms-empty" id="msEmpty" hidden>No matches</div>
                </div>
              </div>
              <input type="hidden" name="tests" id="testsValue" required />
              <div class="hint">CBC, TSH, Fasting Sugar, PP, HbA1C, D-Dimer, Goodness A1, Goodness A2</div>
            </div>

            <div>
              <label>Dr. Name</label>
              <input type="text" name="doctor" placeholder="Referring doctor" />
            </div>

            <div>
              <label class="req">Date</label>
              <input type="date" name="date" id="visitDate" required />
            </div>

            <div>
              <label class="req">Time of Visit</label>
              <input type="time" name="time_of_visit" id="visitTime" required />
            </div>

            <div>
              <label>PP Time</label>
              <input type="time" name="pp_time" id="ppTime" class="readonly" />
              <div class="hint">Auto +2 hours if PP test selected (editable)</div>
            </div>

            <div>
              <label>Report Delivery</label>
              <select name="report_delivery">
                <option value="needed" selected>needed</option>
                <option value="not needed">not needed</option>
              </select>
            </div>

            <div>
              <label class="req">Visit Type</label>
              <select name="visit_type" id="visitType" required>
                <option value="" disabled selected>Select</option>
                <option>branch A</option>
                <option>branch B</option>
                <option>Home visit</option>
              </select>
              <div class="hint">Address required for Home visit</div>
            </div>

            <div>
              <label>Phlebotomist</label>
              <select name="phlebotomist">
                <option value="" selected>—</option>
                <option>Saket Kumar</option>
                <option>Meena Shinde</option>
                <option>Ankita Dev</option>
                <option>Subhash Patel</option>
              </select>
            </div>

            <div>
              <label class="req">Company</label>
              <select name="company" id="company" required>
                <option value="" disabled selected>Select</option>
                <option>company 1</option>
                <option>company 2</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card-header">
          <h2 class="text-xl sm:text-2xl font-semibold">Payment Details</h2>
        </div>
        <div class="card-body">
          <div class="grid cols-3">
            <div>
              <label>Cost (auto)</label>
              <input type="text" id="cost" class="readonly money" name="cost_display" value="₹0" readonly />
              <input type="hidden" id="costRaw" name="cost" value="0" />
            </div>

            <div>
              <label>Discount</label>
              <input type="number" id="discount" name="discount" min="0" step="1" placeholder="0" />
            </div>

            <div>
              <label>Final Price</label>
              <input type="text" id="finalPrice" class="readonly money" name="final_display" value="₹0" readonly />
              <input type="hidden" id="finalRaw" name="final_price" value="0" />
            </div>

            <div>
              <label>Payment Mode</label>
              <select name="payment_mode">
                <option value="" selected>—</option>
                <option>cash</option>
                <option>online</option>
              </select>
            </div>

            <div>
              <label>Payment Status</label>
              <select id="paymentStatus" name="payment_status">
                <option>Not done</option>
                <option>Pending (some amount pending)</option>
                <option>Completed</option>
              </select>
            </div>

            <div>
              <label>Pending Payment</label>
              <input type="number" id="pendingPayment" name="pending_payment" min="0" step="1" placeholder="Auto" />
              <div class="hint" id="pendingHint">Auto-fills based on status</div>
            </div>
          </div>
        </div>

        <div class="card-header">
          <h2 class="text-xl sm:text-2xl font-semibold">Completion Details</h2>
        </div>
        <div class="card-body">
          <div class="grid cols-3">
            <div class="span-all">
              <label>Process Completed</label>
              <select id="completion" name="completion">
                <option>scheduled</option>
                <option>assigned phlebotomist</option>
                <option>blood collection done</option>
                <option>PP collection done</option>
                <option>Reports send</option>
                <option>reports delivered</option>
                <option>all Complete</option>
              </select>
              <div class="hint">Progress updates as you change the stage</div>
            </div>

            <!-- Full-width progress bar -->
            <div class="span-all">
              <label style="display:block;margin-bottom:6px">Progress</label>
              <div class="progress"><div class="bar" id="progressBar"></div></div>
            </div>
          </div>

          <div class="actions">
            <button type="reset" class="btn ghost">Clear</button>
            <button type="submit" id="submitBtn" class="btn primary">
              <span id="submitContent">Submit Entry</span>
            </button>
          </div>
        </div>

        <!-- Edit ID (hidden) -->
        <input type="hidden" id="editId" name="id" />
      </form>
    </section>
  </div>

  <div class="toast" id="toast">Saved!</div>

<script>
  /* =========================
     Config
     ========================= */
  // IMPORTANT: Set this to your Google Apps Script Web App URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8AYTsTSLDg60t57KWnsG9OhwOPsm3Dx-u9K3eHAeFDd3h1DXP2cZo5oXV3xwQNjdaww/exec";

  /* =========================
     Prices / Tests
     ========================= */
  const TESTS = ["CBC","TSH","Fasting Sugar","PP","HbA1C","D-Dimer","Goodness A1","Goodness A2"];
  const PRICES = {
    "company 1": { "CBC":250,"TSH":500,"Fasting Sugar":200,"PP":100,"HbA1C":300,"D-Dimer":800,"Goodness A1":1500,"Goodness A2":2000 },
    "company 2": { "CBC":200,"TSH":600,"Fasting Sugar":250,"PP":100,"HbA1C":200,"D-Dimer":900,"Goodness A1":1800,"Goodness A2":2200 }
  };

  /* =========================
     Helpers
     ========================= */
  const el = (q) => document.querySelector(q);
  const $ = (q,root=document)=> Array.from(root.querySelectorAll(q));
  const fmtINR = (n) => "₹" + (Number(n)||0).toLocaleString("en-IN");
  const toKey = s => (s||"").trim().toLowerCase();

  /* =========================
     Tabs
     ========================= */
  const panels = { inprogress: el("#panel-inprogress"), newentry: el("#panel-newentry") };
  $(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.tab;
      Object.keys(panels).forEach(k=>panels[k].hidden = k!==id);
      if(id==="inprogress") renderInProgress();
    });
  });

  /* =========================
     Multiselect (Tests)
     ========================= */
  const testsSelect = el("#testsSelect");
  const chips = el("#chips");
  const msInput = el("#msInput");
  const msPopup = el("#msPopup");
  const msList = el("#msList");
  const msEmpty = el("#msEmpty");
  const testsValue = el("#testsValue");
  let selectedTests = [];

  function renderChips(){
    chips.innerHTML = "";
    selectedTests.forEach(t => {
      const c = document.createElement("span");
      c.className = "chip";
      c.innerHTML = `<span>${t}</span><button title="Remove" aria-label="Remove">&times;</button>`;
      c.querySelector("button").addEventListener("click", () => {
        selectedTests = selectedTests.filter(x => x!==t);
        syncTests();
      });
      chips.appendChild(c);
    });
    chips.appendChild(msInput);
    testsValue.value = selectedTests.join(", ");
    autoPPTime();
    calcCost();
    updateProgress();
  }

  function openPopup(){
    if(msPopup.hidden){
      msPopup.hidden = false;
      testsSelect.setAttribute("aria-expanded","true");
      filterList(msInput.value.trim());
    }
  }
  function closePopup(){
    if(!msPopup.hidden){
      msPopup.hidden = true;
      testsSelect.setAttribute("aria-expanded","false");
    }
  }
  function filterList(q){
    const items = TESTS
      .filter(t => t.toLowerCase().includes((q||"").toLowerCase()))
      .filter(t => !selectedTests.includes(t));

    msList.innerHTML = "";
    if(items.length===0){ msEmpty.hidden = false; return; }
    msEmpty.hidden = true;
    items.forEach(t=>{
      const li = document.createElement("li");
      li.className = "ms-item";
      li.textContent = t;
      li.addEventListener("click", ()=>{
        if(!selectedTests.includes(t)){
          selectedTests.push(t);
          syncTests(true);
          msInput.focus();
          filterList(msInput.value.trim());
        }
      });
      msList.appendChild(li);
    });
  }
  function syncTests(keepOpen=false){
    renderChips();
    filterList(msInput.value.trim());
    if(!keepOpen && (!msInput.value || msInput.value.trim()==="")) closePopup();
  }
  testsSelect.addEventListener("pointerdown", ()=>{ msInput.focus(); openPopup(); });
  msInput.addEventListener("focus", openPopup);
  msInput.addEventListener("input", (e)=> filterList(e.target.value));
  msInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); }
    if(e.key === "Backspace" && !msInput.value && selectedTests.length){
      selectedTests.pop(); syncTests(true);
    }
  });
  document.addEventListener("click",(e)=>{ if(!testsSelect.contains(e.target)) closePopup(); });
  filterList("");

  /* =========================
     Address required if Home visit
     ========================= */
  const visitType = el("#visitType");
  const address = el("#address");
  const addrLabel = el("#addrLabel");
  visitType.addEventListener("change", ()=>{
    const hv = visitType.value === "Home visit";
    address.required = hv;
    addrLabel.classList.toggle("req", hv);
    if(hv && !address.value) address.focus();
  });

  /* =========================
     PP time auto (+2 hours) if PP selected
     ========================= */
  const visitTime = el("#visitTime");
  const ppTime = el("#ppTime");
  function autoPPTime(){
    const hasPP = selectedTests.includes("PP");
    ppTime.readOnly = !hasPP;
    ppTime.classList.toggle("readonly", !hasPP);
    if(!hasPP){ ppTime.value = ""; return; }
    if(visitTime.value){
      const [h,m] = visitTime.value.split(":").map(Number);
      const dt = new Date(); dt.setHours(h, m, 0, 0); dt.setHours(dt.getHours()+2);
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      if(!ppTime.dataset.manual) ppTime.value = `${hh}:${mm}`;
    }
  }
  visitTime.addEventListener("change", autoPPTime);
  ppTime.addEventListener("input", ()=>{ ppTime.dataset.manual = "1"; });

  /* =========================
     Pricing
     ========================= */
  const company = el("#company");
  const cost = el("#cost");
  const costRaw = el("#costRaw");
  const discount = el("#discount");
  const finalPrice = el("#finalPrice");
  const finalRaw = el("#finalRaw");
  function calcCost(){
    const co = company.value;
    let total = 0;
    if(PRICES[co]){ selectedTests.forEach(t => { total += PRICES[co][t] || 0; }); }
    const disc = Math.max(0, Number(discount.value||0));
    const final = Math.max(0, total - disc);
    cost.value = fmtINR(total); costRaw.value = String(total);
    finalPrice.value = fmtINR(final); finalRaw.value = String(final);
    autoPending();
  }
  company.addEventListener("change", calcCost);
  discount.addEventListener("input", calcCost);

  /* =========================
     Payment logic
     ========================= */
  const paymentStatus = el("#paymentStatus");
  const pendingPayment = el("#pendingPayment");
  const pendingHint = el("#pendingHint");
  function autoPending(){
    const status = paymentStatus.value;
    const final = Number(finalRaw.value||0);
    if(status === "Not done"){
      pendingPayment.value = final || 0; pendingPayment.readOnly = true;
      pendingHint.textContent = "Not done → Pending equals Final Price";
    } else if(status === "Completed"){
      pendingPayment.value = 0; pendingPayment.readOnly = true;
      pendingHint.textContent = "Completed → Pending is 0";
    } else {
      pendingPayment.readOnly = false;
      pendingHint.textContent = "Enter remaining amount (0 < pending < final)";
      if(Number(pendingPayment.value||0) >= final) pendingPayment.value = final>0 ? final-1 : 0;
      if(final===0) pendingPayment.value = 0;
    }
  }
  paymentStatus.addEventListener("change", autoPending);
  pendingPayment.addEventListener("input", ()=>{
    const final = Number(finalRaw.value||0);
    if(paymentStatus.value.includes("Pending")){
      let p = Number(pendingPayment.value||0);
      if(p >= final) pendingPayment.value = final>0 ? final-1 : 0;
      if(p < 0) pendingPayment.value = 0;
    }
  });

  /* =========================
     Progress Bar
     ========================= */
  const completion = el("#completion");
  const progressBar = el("#progressBar");
  const STAGES = ["scheduled","assigned phlebotomist","blood collection done","PP collection done","Reports send","reports delivered","all Complete"];
  function stagePercent(stage){
    const idx = STAGES.map(s=>s.toLowerCase()).indexOf((stage||"").toLowerCase());
    const pct = idx<0 ? 0 : Math.round(((idx+1) / STAGES.length) * 100);
    return pct;
  }
  function updateProgress(){
    const pct = stagePercent(completion.value);
    progressBar.style.width = pct + "%";
  }
  completion.addEventListener("change", updateProgress);
  updateProgress();

  /* =========================
     Toast
     ========================= */
  const toast = el("#toast");
  function showToast(msg="Saved!"){
    toast.textContent = msg; toast.classList.add("show");
    setTimeout(()=> toast.classList.remove("show"), 2200);
  }

  /* =========================
     Local cache for listing/editing
     ========================= */
  const LS_KEY = "ghc_entries_cache_v1";
  const cache = {
    all(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } },
    save(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); },
    upsert(entry){
      const list = cache.all();
      const i = list.findIndex(e=> String(e.id)===String(entry.id));
      if(i>-1) list[i]=entry; else list.unshift(entry);
      cache.save(list);
    }
  };

  /* =========================
     Fetch server list to cache
     ========================= */
  async function fetchServerList(){
    try{
      const url = SCRIPT_URL + "?action=list";
      const res = await fetch(url, {method:"GET"});
      if(!res.ok) throw new Error("Bad status");
      const data = await res.json();
      if(Array.isArray(data)){
        const current = cache.all();
        const map = new Map(current.map(e=>[String(e.id), e]));
        data.forEach(d=>{
          const key = String(d.id || d.ID || d.row || Date.now()+Math.random());
          map.set(key, {...map.get(key), ...d, id:key});
        });
        cache.save(Array.from(map.values()));
      }
    }catch(e){ /* fallback to cache */ }
  }

  /* =========================
     In Progress rendering as Cards + Delete
     ========================= */
  const inProgressList = el("#inProgressList");
  const inProgressEmpty = el("#inProgressEmpty");

  function renderInProgress(){
    const items = cache.all().filter(e => toKey(e.completion) !== "all complete" && toKey(e.completion) !== "all complete.");
    inProgressList.innerHTML = "";
    if(items.length===0){ inProgressEmpty.style.display = "block"; return; }
    inProgressEmpty.style.display = "none";

    items.forEach(e=>{
      const row = document.createElement("div");
      row.className = "card-item";
      const pct = stagePercent(e.completion);

      row.innerHTML = `
        <div class="card-top">
          <div class="card-name" title="${e.patient_name||"-"}">${e.patient_name || "-"}</div>
          <div class="card-date">${e.date || "-"}</div>
        </div>
        <div class="card-stage">Stage: <strong>${e.completion || "scheduled"}</strong></div>
        <div class="progress" aria-label="Progress"><div class="bar" style="width:${pct}%"></div></div>
        <div class="card-actions">
          <button class="btn ghost sm" data-edit="${e.id}">Edit</button>
          <button class="btn danger sm" data-del="${e.id}">Delete</button>
        </div>
      `;

      row.querySelector('[data-edit]').addEventListener("click", ()=> loadForEdit(e));
      row.querySelector('[data-del]').addEventListener("click", ()=> deleteEntry(e.id));

      inProgressList.appendChild(row);
    });
  }

  async function deleteEntry(id){
    if(!confirm("Delete this entry permanently?")) return;
    try{
      const res = await fetch(`${SCRIPT_URL}?action=delete&id=${encodeURIComponent(id)}`, {method:"GET"});
      const data = await res.json().catch(()=>({ok:false}));
      if(data && data.ok){
        const list = cache.all().filter(x => String(x.id)!==String(id));
        cache.save(list);
        renderInProgress();
        showToast("Entry deleted");
      }else{
        showToast("Delete failed");
      }
    }catch(err){
      console.error(err);
      showToast("Error deleting");
    }
  }

  /* =========================
     Edit flow
     ========================= */
  function loadForEdit(e){
    document.querySelector('.tab-btn[data-tab="newentry"]').click();

    el('[name="patient_name"]').value = e.patient_name || "";
    el('[name="age"]').value = e.age || "";
    el('[name="gender"]').value = e.gender || "";

    el('[name="contact"]').value = e.contact || "";
    el('[name="alt_contact"]').value = e.alt_contact || "";
    el('#address').value = e.address || "";

    selectedTests = (e.tests ? String(e.tests).split(",").map(s=>s.trim()).filter(Boolean) : []);
    syncTests(false);

    el('[name="doctor"]').value = e.doctor || "";
    el('#visitDate').value = e.date || "";
    el('#visitTime').value = e.time_of_visit || "";
    el('#ppTime').value = e.pp_time || "";
    if(e.pp_time){ ppTime.dataset.manual = "1"; }

    el('[name="report_delivery"]').value = e.report_delivery || "needed";
    el('#visitType').value = e.visit_type || "";
    el('[name="phlebotomist"]').value = e.phlebotomist || "";
    el('#company').value = e.company || "";
    calcCost();

    el('#discount').value = e.discount || "";
    el('[name="payment_mode"]').value = e.payment_mode || "";
    el('#paymentStatus').value = e.payment_status || "Not done";
    el('#pendingPayment').value = e.pending_payment || "";
    autoPending();

    el('#completion').value = e.completion || "scheduled";
    updateProgress();

    el('#editId').value = e.id || "";
    el('#submitContent').textContent = "Save Changes";
  }

  /* =========================
     Submit with loading state
     ========================= */
  const form = el("#entryForm");
  const submitBtn = el("#submitBtn");

  function setSubmitting(on){
    if(on){
      submitBtn.setAttribute("disabled","disabled");
      submitBtn.innerHTML = `<span class="spinner" aria-hidden="true"></span>Saving...`;
    }else{
      submitBtn.removeAttribute("disabled");
      submitBtn.innerHTML = `<span id="submitContent">${el("#editId").value ? "Save Changes" : "Submit Entry"}</span>`;
    }
  }

  form.addEventListener("reset", ()=>{
    selectedTests = []; syncTests(false); calcCost(); autoPending(); updateProgress();
    ppTime.dataset.manual = "";
    el("#editId").value = "";
    el("#submitContent").textContent = "Submit Entry";
    setDefaults();
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();

    if(!testsValue.value){ showToast("Please select at least one test"); msInput.focus(); return; }
    if(el("#visitType").value === "Home visit" && !el("#address").value.trim()){ el("#address").reportValidity(); el("#address").focus(); showToast("Address is required for Home visit"); return; }
    if(selectedTests.includes("PP") && !el("#ppTime").value){ showToast("Please confirm PP time"); el("#ppTime").focus(); return; }
    if(el("#paymentStatus").value.includes("Pending")){
      const f = Number(el("#finalRaw").value||0);
      const p = Number(el("#pendingPayment").value||0);
      if(!(p > 0 && p < f)){ showToast("Pending must be > 0 and < Final"); el("#pendingPayment").focus(); return; }
    }

    const data = new FormData(form);
    data.set("tests", selectedTests.join(", "));
    data.set("cost", el("#costRaw").value);
    data.set("final_price", el("#finalRaw").value);
    const date = el("#visitDate").value || "";
    const time = el("#visitTime").value || "";
    data.set("visit_datetime", date && time ? `${date}T${time}` : "");

    const id = el("#editId").value || String(Date.now());
    data.set("id", id);

    setSubmitting(true);

    try{
      await fetch(SCRIPT_URL, { method:"POST", body:data, mode:"no-cors" });

      const entryObj = {
        id,
        patient_name: data.get("patient_name"),
        age: data.get("age"),
        gender: data.get("gender"),
        contact: data.get("contact"),
        alt_contact: data.get("alt_contact"),
        address: data.get("address"),
        tests: data.get("tests"),
        doctor: data.get("doctor"),
        date: data.get("date"),
        time_of_visit: data.get("time_of_visit"),
        pp_time: data.get("pp_time"),
        report_delivery: data.get("report_delivery"),
        visit_type: data.get("visit_type"),
        phlebotomist: data.get("phlebotomist"),
        company: data.get("company"),
        cost: data.get("cost"),
        discount: data.get("discount"),
        final_price: data.get("final_price"),
        payment_mode: data.get("payment_mode"),
        payment_status: data.get("payment_status"),
        pending_payment: data.get("pending_payment"),
        completion: data.get("completion")
      };
      cache.upsert(entryObj);
      renderInProgress();

      showToast(el("#editId").value ? "Changes saved" : "Entry saved successfully");

      form.reset();
      selectedTests = []; syncTests(false); calcCost(); autoPending(); updateProgress();
      ppTime.dataset.manual = "";
      setDefaults();
      el("#editId").value = "";
      el("#submitContent").textContent = "Submit Entry";
      document.querySelector('.tab-btn[data-tab="inprogress"]').click();
    }catch(err){
      console.error(err);
      showToast("Failed to save. Check Apps Script deployment & CORS");
    }finally{
      setSubmitting(false);
    }
  });

  /* =========================
     Defaults
     ========================= */
  function setDefaults(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    el("#visitDate").value = `${yyyy}-${mm}-${dd}`;
    el("#visitTime").value = `${hh}:${mi}`;
    autoPPTime();
  }

  /* =========================
     Patient Name Auto-Suggestion + Autofill
     ========================= */
  const patientNameInput = el("#patientName");
  const nameSuggestions = el("#nameSuggestions");
  let debounceTimer;
  patientNameInput.addEventListener("input", ()=>{
    clearTimeout(debounceTimer);
    const q = patientNameInput.value.trim();
    if(!q){ nameSuggestions.hidden = true; nameSuggestions.innerHTML=""; return; }
    debounceTimer = setTimeout(()=> fetchSuggestions(q), 280);
  });
  document.addEventListener("click", (ev)=>{
    if(!nameSuggestions.contains(ev.target) && ev.target!==patientNameInput){
      nameSuggestions.hidden = true;
    }
  });

  async function fetchSuggestions(q){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=patients&q=${encodeURIComponent(q)}`, {method:"GET"});
      if(!res.ok) throw new Error("bad status");
      const data = await res.json();
      if(!Array.isArray(data) || !data.length){ nameSuggestions.hidden = true; nameSuggestions.innerHTML=""; return; }
      nameSuggestions.innerHTML = "";
      data.forEach(p=>{
        const d = document.createElement("div");
        d.textContent = p.patient_name || "";
        d.addEventListener("click", ()=> selectPatient(p));
        nameSuggestions.appendChild(d);
      });
      nameSuggestions.hidden = false;
    }catch(err){
      console.error(err);
      nameSuggestions.hidden = true;
    }
  }

  function selectPatient(p){
    patientNameInput.value = p.patient_name || "";
    nameSuggestions.hidden = true;

    // Autofill latest info for that patient
    el('[name="age"]').value = p.age || "";
    el('[name="gender"]').value = p.gender || "";
    el('[name="contact"]').value = p.contact || "";
    el('[name="alt_contact"]').value = p.alt_contact || "";
    el('#address').value = p.address || "";
  }

  /* =========================
     Init
     ========================= */
  setDefaults();
  fetchServerList().then(renderInProgress);
</script>
</body>
</html>
