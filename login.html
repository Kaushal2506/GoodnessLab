<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login | Pathology Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="css/custom.css" />
</head>

<body class="bg-gray-50">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-lg shadow-md overflow-hidden">
      <div class="bg-blue-600 py-4 px-6">
        <h1 class="text-2xl font-bold text-white">Pathology Lab Login</h1>
        <p class="text-blue-100">Access your lab management dashboard</p>
      </div>

      <form id="loginForm" class="p-6 space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="username" name="username" required 
                 class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                 autocomplete="username">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <div class="relative">
            <input type="password" id="password" name="password" required minlength="6"
                   class="w-full pr-11 px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                   autocomplete="current-password">
            <!-- Eye toggle button -->
            <button type="button" id="togglePassword"
                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700"
                    aria-label="Show password" aria-pressed="false">
              <i id="eyeIcon" class="fa-solid fa-eye"></i>
            </button>
          </div>
        </div>

        <button id="signInBtn" type="submit" 
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
          Sign In
        </button>

        <p id="errBox" class="text-sm text-red-600 hidden"></p>
        <p id="okBox" class="text-sm text-green-700 hidden">Login successful. Redirecting…</p>
      </form>

      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
        <p class="text-xs text-gray-500 text-center">© 2025 Pathology Lab Management System. All rights reserved.</p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden transform translate-y-2 opacity-0 transition duration-300 ease-in-out p-4 rounded shadow text-white bg-green-500 z-50">
    <span id="toastMessage"></span>
  </div>

  <!-- Firebase SDK (MODULAR v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // 🔐 Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCXQyQRw4JRaWDNbca4YQkanMWnfu8SuH0",
      authDomain: "pathologylab-9d156.firebaseapp.com",
      projectId: "pathologylab-9d156",
      storageBucket: "pathologylab-9d156.appspot.com",
      messagingSenderId: "874537581352",
      appId: "1:874537581352:web:9dbcbe269d561c8d676e1d",
      measurementId: "G-S279W29G9Q"
    };

    // ✅ Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    auth.useDeviceLanguage?.();

    const loginForm = document.getElementById("loginForm");
    const signInBtn = document.getElementById("signInBtn");
    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");

    // 🔄 Always start the login page from a clean state (prevents auto-redirect)
    // If you prefer not to force sign-out, remove the next two lines.
    try { await signOut(auth); } catch (_) {}

    // Password eye toggle
    const passwordInput = document.getElementById("password");
    const togglePasswordBtn = document.getElementById("togglePassword");
    const eyeIcon = document.getElementById("eyeIcon");
    togglePasswordBtn.addEventListener("click", () => {
      const isHidden = passwordInput.type === "password";
      passwordInput.type = isHidden ? "text" : "password";
      togglePasswordBtn.setAttribute("aria-pressed", String(isHidden));
      togglePasswordBtn.setAttribute("aria-label", isHidden ? "Hide password" : "Show password");
      eyeIcon.classList.toggle("fa-eye");
      eyeIcon.classList.toggle("fa-eye-slash");
    });

    function showError(msg) {
      errBox.textContent = msg;
      errBox.classList.remove("hidden");
      okBox.classList.add("hidden");
      showToast(msg, "error");
    }
    function showOk(msg) {
      okBox.textContent = msg;
      okBox.classList.remove("hidden");
      errBox.classList.add("hidden");
      showToast(msg, "success");
    }
    function showToast(message, type = 'success') {
      if (!toast) return;
      toastMessage.textContent = message;
      toast.classList.remove("hidden", "opacity-0", "translate-y-2");
      toast.classList.add("opacity-100", "translate-y-0");
      toast.style.backgroundColor = type === 'error' ? '#DC2626' : '#16A34A';
      setTimeout(() => {
        toast.classList.add("opacity-0", "translate-y-2");
        setTimeout(() => toast.classList.add("hidden"), 300);
      }, 2500);
    }

    // Friendly error messages
    function friendlyError(code, fallback) {
      const map = {
        "auth/invalid-email": "Invalid email format.",
        "auth/user-disabled": "This account has been disabled.",
        "auth/user-not-found": "No account found with that email.",
        "auth/wrong-password": "Incorrect password.",
        "auth/too-many-requests": "Too many attempts. Try again later.",
        "auth/network-request-failed": "Network error. Check your connection."
      };
      return map[code] || fallback || "Sign-in failed.";
    }

    // Handle login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      errBox.classList.add("hidden");
      okBox.classList.add("hidden");

      const email = /** @type {HTMLInputElement} */(document.getElementById("username")).value.trim();
      const password = passwordInput.value;
      if (!email || !password) return showError("Please enter email and password.");

      // Disable to prevent double submit
      signInBtn.disabled = true;
      signInBtn.classList.add("opacity-60", "cursor-not-allowed");

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showOk("Login successful. Redirecting…");
        setTimeout(() => window.location.replace("dashboard.html"), 700);
      } catch (err) {
        console.error("Login failed:", err);
        showError(friendlyError(err.code, err.message));
      } finally {
        signInBtn.disabled = false;
        signInBtn.classList.remove("opacity-60", "cursor-not-allowed");
      }
    });
  </script>
</body>
</html>


